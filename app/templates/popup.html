<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Facilitator Timer</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Lato&family=Playfair+Display&family=Oswald&family=Source+Sans+Pro&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Courier New', monospace;
      background-color: #d0f0ff;
      height: 100vh;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    .container {
      display: flex;
      width: 100%;
      height: 100%;
      position: relative;
    }

    .dot-column {
      position: absolute;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .left-dots {
      bottom: 40px;
      left: 20px;
      align-items: flex-start;
    }

    .right-dots {
      bottom: 40px;
      right: 20px;
      align-items: flex-end;
    }

    .dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }

    .red {
      background-color: red;
    }

    .green {
      background-color: green;
    }

    .center {
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding-top: 40px;
    }

    .timer-display {
      font-size: clamp(2rem, 30vw, 30rem);
      margin: 0;
      line-height: 1;
    }

    .buttons{
      display: grid;
      grid-template-columns: 60px auto 60px;  /* Set | Start/Stop | Reset */
      justify-content: center;                /* centre the middle column under timer */
      align-items: center;
      gap: 20px;
      margin-top: 20px;
      width: 100%;
    }
    /* when only the Start/Stop pill is visible, collapse to a single column */
    .buttons.single{
      grid-template-columns: auto;
    }

    button {
      font-size: 1.2rem;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background-color: #e0e0e0;
      cursor: pointer;
    }
    /* ‚îÄ‚îÄ‚îÄ Pill‚Äëbutton look & feel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
:root{
  --btn-primary:#333;   /* will be overwritten by JS loader   */
  --btn-secondary:#666; /* ditto                             */
}

    /* Icon-only style for the bottom-left Tools button */
#config-button.icon-only{
  border: none;
  background: none;
  padding: 0;
  width: auto;
  height: auto;
  color: var(--btn-primary);   /* match primary font colour */
}
/* Bigger cog icon (2√ó) */
#config-button.icon-only svg{
  width:2em;
  height:2em;
}

.buttons button{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-family:inherit;
  font-size:1.25rem;        /* was 1rem ‚Üí bigger */
  font-weight:600;          /* bolder text */
  padding:10px 22px;
  border-radius:9999px;
  border:2px solid currentColor;
  background:none;
  cursor:pointer;
  transition:background .15s,color .15s;
}
.buttons button.primary-idle   {color:var(--btn-primary);}
.buttons button.primary-active{
  background:var(--btn-primary);
  color:#fff;
}
.buttons button.secondary      {color:var(--btn-secondary);}
/* small glyph size (linked to button font) */
.buttons .icon,
.buttons svg{
  width:1.35em;     /* 35‚ÄØ% larger than before */
  height:1.35em;
  line-height:1;
}
    /* perfectly‚Äëround buttons */
    .buttons button.round{
      width:60px;
      height:60px;
      padding:0;
      justify-content:center;  /* centres Set text or icon */
      border-radius:50%;
      flex-shrink:0;           /* keep them circular in flex layout */
      /* keep circle size but make label/icon scale with overall font */
      font-size:1.25rem;
      font-weight:600;
    }
    .buttons button.round .icon{
      margin:0;                /* no horizontal gap needed */
    }

    /* ‚îÄ‚îÄ Global round‚Äëbutton helper (for config button outside .buttons grid) ‚îÄ‚îÄ */
    .round{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:60px;
      height:60px;
      padding:0;
      border-radius:50%;
      border:2px solid currentColor;
      font-size:1.25rem;
      font-weight:600;
      background:none;
      cursor:pointer;
    }
    .round svg{
      width:1.35em;
      height:1.35em;
    }

    .qr-section {
      margin-top: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .qr-section img {
      width: 140px;
      height: 140px;
    }

    .qr-label{
      font-size:0.85rem;
      color:var(--btn-secondary);  /* softer tint based on primary font */
      opacity:0.6;                /* less visual weight */
    }

    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .flashing-red {
      color: red;
      text-shadow: 0 0 8px white, 0 0 12px white;
      animation: flash 1s infinite;
    }

    /* Responsive layout for 3 stages */
    /* ‚îÄ‚îÄ Reusable helper: .hidden { display:none !important; } ‚îÄ‚îÄ */
    .hidden{
      display:none !important;
    }

    @media (min-width: 651px){
      #config-button{
        position: fixed;
        left: 80px;      /* was 20px; keeps clear of left‚Äëdot column */
        bottom: 20px;
        margin: 0;
      }
    }

    @media (max-width: 650px) {
      #config-button {
        display: none !important;
      }
    }

    @media (max-width: 600px) {
      .container > .dot-column,
      .buttons,
      .qr-section {
        display: none !important;
      }

      .center {
        padding-top: 20px;
        justify-content: center;
        align-items: center;
      }

      .timer-display {
        font-size: clamp(3rem, 30vw, 12rem);
      }
    }

    @media (max-width: 600px) and (min-height: 300px) {
      .container > .dot-column {
        display: flex !important;
      }

      .buttons,
      .qr-section {
        display: none !important;
      }

      .center {
        padding-top: 20px;
        justify-content: center;
        align-items: center;
      }

      .timer-display {
        font-size: clamp(3rem, 30vw, 12rem);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="left-dots" class="dot-column left-dots"></div>

    <div class="center">
      <h1 id="timer-display" class="timer-display">00:00</h1>
      <div class="buttons">
        <button id="options-button"
                class="secondary round hidden"
                title="Open Settings">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round"
               class="icon icon-tabler icon-tabler-pencil">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
            <path d="M13.5 6.5l4 4" />
          </svg>
        </button>

        <button id="toggle-button"
                class="primary-idle">
          <!-- Play icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round"
               class="icon icon-tabler icon-tabler-player-play">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M7 4v16l13 -8z" />
          </svg>
          Start
        </button>

        <button id="reset-button"
                class="secondary round hidden"
                title="Reset App">
          <!-- Rotate‚Äëclockwise icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round"
               class="icon icon-tabler icon-tabler-rotate-clockwise">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M4.05 11a8 8 0 1 1 .5 4m-.5 5v-5h5" />
          </svg>
        </button>
      </div>

      <!-- Tools (config) button pinned bottom‚Äëleft via CSS -->
      <button id="config-button"
              class="secondary icon-only"
              title="View Config">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round"
             class="icon icon-tabler icon-tabler-settings">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z" />
          <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
        </svg>
      </button>

      <div class="qr-section">
        <img src="/qr-image?session=default" alt="QR Code" onclick="openQrPopup()" style="cursor: pointer;">

        <div style="font-size: 0.85rem; display: flex; gap: 12px; align-items: center;">
          <span id="session-indicator"
                onclick="openSettings()"
                style="text-decoration: underline; cursor: pointer; color: var(--btn-primary);">
            No session ID currently defined
          </span>
        </div>

        <div class="qr-label">(c) Patrick Zakher - Facilitator Timer v4.02</div>
      </div>
    </div>

    <div id="right-dots" class="dot-column right-dots"></div>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ Detect ?session=XYZ on first load and store ‚îÄ‚îÄ‚îÄ
    (function initSessionFromURL() {
      const urlSess = new URLSearchParams(window.location.search).get("session");
      if (urlSess) {
        sessionStorage.setItem("session", urlSess);
      }
    })();
    let lastKnownBackgroundImage = null;

    let totalSeconds = 0;
    let intervalId    = null;
    let lastSeenCount = 0;
    let config = null;

    const optionsBtn   = document.getElementById("options-button");
    const toggleBtn    = document.getElementById("toggle-button");
    const resetBtn     = document.getElementById("reset-button");
    const configBtn    = document.getElementById("config-button");
    const timerDisplay = document.getElementById("timer-display");
    const buttonsContainer = document.querySelector(".buttons");
    function updateButtonsLayout() {
      const onlyMiddle = optionsBtn.classList.contains("hidden") &&
                         resetBtn.classList.contains("hidden");
      buttonsContainer.classList.toggle("single", onlyMiddle);
    }

    // Inline SVG markup for play/stop (Tabler Icons, MIT)
    const playSvg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
           viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round"
           class="icon icon-tabler icon-tabler-player-play">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M7 4v16l13 -8z" />
      </svg>`;
    const stopSvg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
           viewBox="0 0 24 24" fill="currentColor"
           class="icon icon-stop-square">
        <path fill-rule="evenodd"
              clip-rule="evenodd"
              d="M4.5 7.5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-9a3 3 0 0 1-3-3v-9Z"/>
      </svg>`;

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Workflow flags ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let hasConfig = false;  // becomes true after the user saves settings once
    let resetStage  = 0;   // 0 ‚Üí first click will restore; 1 ‚Üí next click will zero & hide
    const lastConfigured = {
      seconds: 0,
      red: 0,
      green: 0,
      dotSize: "S"
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Session Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getCurrentSession() {
      // Prefer sessionStorage if available for session persistence
      const stored = sessionStorage.getItem("session");
      if (stored && stored !== "default") {
        return stored;
      }
      const text = document.getElementById("session-indicator").textContent;
      if (text.startsWith("Session ID: ")) {
        return text.replace("Session ID: ", "");
      }
      return "default";
    }

    // Keep address bar in sync with current session
    function updateAddressBar(session) {
      const url = new URL(window.location);
      url.searchParams.set("session", session);
      window.history.replaceState(null, "", url);
    }

    // Restore session from sessionStorage on reload
    window.addEventListener("DOMContentLoaded", () => {
      const sessionIndicator = document.getElementById("session-indicator");
      const stored = sessionStorage.getItem("session") || "default";
      sessionIndicator.textContent = `Session ID: ${stored}`;
      updateAddressBar(stored);
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Button Handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    optionsBtn.onclick = openSettings;

toggleBtn.addEventListener("click", () => {
  // If timer is at 0 OR no config yet ‚Üí open Settings dialog
  if (totalSeconds === 0 || !hasConfig) {
    openSettings();
    return;
  }

  if (!intervalId && totalSeconds > 0) {
        // Start timer
        intervalId = setInterval(() => {
          totalSeconds--;
          updateTimerDisplay();
          if (totalSeconds <= 0) {
            clearInterval(intervalId);
            intervalId = null;
            toggleBtn.innerHTML = `${playSvg} Start`;
            toggleBtn.classList.remove("primary-active");
            toggleBtn.classList.add("primary-idle");
            toggleBtn.disabled = true;
            timerDisplay.textContent = "00:00";
            timerDisplay.style.color = "red";
            timerDisplay.classList.add("flashing-red");
          }
        }, 1000);
        toggleBtn.innerHTML = `${stopSvg} Stop`;
        toggleBtn.classList.remove("primary-idle");
        toggleBtn.classList.add("primary-active");
        resetBtn.classList.remove("hidden");
        resetStage = 0;
        updateButtonsLayout();
      } else {
        // Pause timer
        clearInterval(intervalId);
        intervalId = null;
        toggleBtn.innerHTML = `${playSvg} Start`;
        toggleBtn.classList.remove("primary-active");
        toggleBtn.classList.add("primary-idle");
      }
    });

    resetBtn.addEventListener("click", () => {
      if (resetStage === 0) {
        /* ‚îÄ‚îÄ FIRST CLICK: restore to last configured values ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        clearInterval(intervalId);
        intervalId = null;
        lastSeenCount = 0;                // avoid false ‚ÄúüèÅ‚Äù state on next ping

        totalSeconds = lastConfigured.seconds;
        updateTimerDisplay();
        timerDisplay.style.color      = config?.ui?.font_color || "";
        timerDisplay.style.fontWeight = "";
        timerDisplay.classList.remove("flashing-red");

        // Regenerate dots
        document.getElementById("left-dots").innerHTML  = "";
        document.getElementById("right-dots").innerHTML = "";
        const currentSession = getCurrentSession();
        fetch(`/reset?session=${encodeURIComponent(currentSession)}`, { method: "POST" });

        const dotSizeMap = { S:1.0, M:1.15, L:1.3, XL:1.5 };
        const scale = dotSizeMap[lastConfigured.dotSize] || 1.0;
        const px = `${Math.round(16 * scale)}px`;

        for (let i = 0; i < lastConfigured.red; i++) {
          const dot = document.createElement("div");
          dot.classList.add("dot", "red");
          dot.style.width = px;
          dot.style.height = px;
          document.getElementById("left-dots").appendChild(dot);
        }
        for (let i = 0; i < lastConfigured.green; i++) {
          const dot = document.createElement("div");
          dot.classList.add("dot", "green");
          dot.style.width = px;
          dot.style.height = px;
          document.getElementById("right-dots").appendChild(dot);
        }

        toggleBtn.innerHTML = `${playSvg} Start`;
        toggleBtn.classList.remove("primary-active");
        toggleBtn.classList.add("primary-idle");
        toggleBtn.disabled = false;      // allow starting again

        // Stay visible; prepare for stage‚Äë2 reset
        resetStage = 1;
        updateButtonsLayout();
      } else {
        /* ‚îÄ‚îÄ SECOND CLICK: full reset to zero, hide Reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        clearInterval(intervalId);
        intervalId = null;
        lastSeenCount = 0;                // fully clear scan state

        totalSeconds = 0;
        updateTimerDisplay();
        timerDisplay.style.color      = config?.ui?.font_color || "";
        timerDisplay.style.fontWeight = "";
        timerDisplay.classList.remove("flashing-red");

        // Clear dots & backend
        document.getElementById("left-dots").innerHTML  = "";
        document.getElementById("right-dots").innerHTML = "";
        const currentSession = getCurrentSession();
        fetch(`/reset?session=${encodeURIComponent(currentSession)}`, { method: "POST" });

        // Hide Reset, hide Set, force new config next time
        resetBtn.classList.add("hidden");
        optionsBtn.classList.add("hidden");
        hasConfig  = false;
        resetStage = 0;

        toggleBtn.innerHTML = `${playSvg} Start`;
        toggleBtn.classList.remove("primary-active");
        toggleBtn.classList.add("primary-idle");
        toggleBtn.disabled = false;      // ensure Start opens Settings again
        timerDisplay.textContent = "00:00";   // ensure plain zero time

        updateButtonsLayout();
      }
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Config Button (opens /edit-config) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openConfig() {
      const width  = 600;
      const height = 600;
      // Position popup 25% from left, vertically centered
      const left = window.screenX + (window.outerWidth - width) * 0.25;
      const top  = window.screenY + (window.outerHeight - height) / 2;
      const currentSession = getCurrentSession();
      let url = "/edit-config";
      if (currentSession !== "default") {
        url += "?session=" + encodeURIComponent(currentSession);
      }
      window.open(
        url,
        "_blank",
        `width=${width},height=${height},left=${left},top=${top},resizable=yes`
      );
    }
    configBtn.addEventListener("click", () => {
      window.addEventListener("focus", () => {
        loadAndApplyConfig(true);
      }, { once: true });
      openConfig();
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Settings & QR Listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openSettings() {
      // Ensure unique session: generate if missing or default
      let sess = sessionStorage.getItem("session");
      if (!sess || sess === "default") {
        const newId = Math.random().toString(36).substr(2, 6).toUpperCase();
        sessionStorage.setItem("session", newId);
      }
      const btnRect = optionsBtn.getBoundingClientRect();
      const width = 500;
      const height = 400;

      const left = window.screenX + btnRect.left;
      const top = window.screenY + btnRect.bottom + 10;

      const settingsWindow = window.open("/settings", "_blank", `width=${width},height=${height},left=${left},top=${top},resizable=yes`);

      // Use getCurrentSession for session_id
      const currentSession = getCurrentSession();

      // Once the window is ready, send it a message to position itself and prefill session_id
      settingsWindow.addEventListener("load", () => {
        settingsWindow.postMessage(
          {
            type: "position-settings-window",
            left,
            top,
            prefill_session_id: currentSession
          },
          "*"
        );
      });
    }
    function openQrPopup() {
      const qrImg = document.querySelector(".qr-section img");
      const rect = qrImg.getBoundingClientRect();
      const width = 500;
      const height = 600;

      const left = window.screenX + rect.left;
      const top = window.screenY + rect.bottom + 10;

      const qrWindow = window.open("/qr-popup", "_blank", `width=${width},height=${height},left=${left},top=${top},resizable=yes`);

      // Use getCurrentSession for session_id
      const currentSession = getCurrentSession();

      // Once the window is ready, send it a message to position itself and pass session_id
      qrWindow.addEventListener("load", () => {
        qrWindow.postMessage(
          {
            type: "position-qr-window",
            left,
            top,
            session_id: currentSession
          },
          "*"
        );
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Timer Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function formatTime(mins, secs) {
      const m = String(mins).padStart(2, '0');
      const s = String(secs).padStart(2, '0');
      return `${m}:${s}`;
    }
    function updateTimerDisplay() {
      const mins = Math.floor(totalSeconds / 60);
      const secs = totalSeconds % 60;
      timerDisplay.textContent = formatTime(mins, secs);
    }
    async function checkForNewScans() {
      try {
        const currentSession = getCurrentSession();
        const res = await fetch(`/ping?session=${encodeURIComponent(currentSession)}`);
        const count = parseInt(await res.text(), 10);
        if (count > lastSeenCount) {
          const redDot = document.querySelector("#left-dots .dot.red");
          if (redDot) {
            redDot.classList.remove("red");
            redDot.classList.add("green");
            document.getElementById("right-dots").appendChild(redDot);
            lastSeenCount = count;
          }
        }
        const remainingRedDots = document.querySelectorAll("#left-dots .dot.red").length;
        if (remainingRedDots === 0 && lastSeenCount > 0) {
          clearInterval(intervalId);
          intervalId = null;
          timerDisplay.textContent = "üèÅ";
          timerDisplay.style.color       = "green";
          timerDisplay.style.fontWeight  = "bold";
          timerDisplay.classList.remove("flashing-red");
          toggleBtn.disabled = true;
          resetBtn.disabled = false;
        }
      } catch (err) {
        console.error("Error pinging for scans:", err);
      }
    }
    setInterval(checkForNewScans, 2000);

window.addEventListener("message", function (event) {
  console.log("üü¢ Received message from settings:", event.data);
  if (event.data.type === "settings") {
    const { minutes, seconds, teams, green_teams, session_id } = event.data;
    if (
      typeof minutes === "number" && !isNaN(minutes) &&
      typeof seconds === "number" && !isNaN(seconds)
    ) {
      totalSeconds = minutes * 60 + seconds;
      if (minutes === -1) {
        // existing negative special-case
        totalSeconds = 0;
        timerDisplay.textContent = "00:00";
        timerDisplay.style.color = "red";
        timerDisplay.classList.add("flashing-red");
        // toggleBtn.disabled = true;
        // resetBtn.disabled = true;
        updateButtonsLayout();
        return;
      }
      // ‚îÄ‚îÄ If timer is zero AND no dots specified ‚Üí treat as fresh/no‚Äëconfig
      const noDotsRequested =
        (typeof teams !== "number" || teams === 0) &&
        (typeof green_teams !== "number" || green_teams === 0);

      if (totalSeconds === 0 && noDotsRequested) {
        hasConfig = false;
        optionsBtn.classList.add("hidden");
        resetBtn.classList.add("hidden");
        resetStage = 0;
        updateButtonsLayout();
        return;   // nothing else to do
      }
      updateTimerDisplay();
      timerDisplay.style.color      = "";
      timerDisplay.style.fontWeight = "";
      timerDisplay.classList.remove("flashing-red");
      if (config && config.ui && config.ui.font_color) {
        timerDisplay.style.color = config.ui.font_color;
      }
      toggleBtn.disabled = false;
      // resetBtn.disabled = false;
    }
        if (typeof teams === "number" && !isNaN(teams)) {
          const leftDots  = document.getElementById("left-dots");
          const rightDots = document.getElementById("right-dots");
          leftDots.innerHTML  = "";
          rightDots.innerHTML = "";
          lastSeenCount = 0;
          const currentSession = getCurrentSession();
          fetch(`/reset?session=${encodeURIComponent(currentSession)}`, { method: "POST" });

          const dotSizeMap = {
            S: 1.0,
            M: 1.15,
            L: 1.3,
            XL: 1.5
          };
          let dotSize = event.data.dot_size;
          if (!dotSize && config && config.ui && config.ui.dot_size) {
            dotSize = config.ui.dot_size;
          }
          const scale = dotSizeMap[dotSize] || 1.0;

          const scaledPx = size => `${Math.round(16 * scale)}px`;

          for (let i = 0; i < teams; i++) {
            const dot = document.createElement("div");
            dot.classList.add("dot", "red");
            dot.style.width = scaledPx();
            dot.style.height = scaledPx();
            leftDots.appendChild(dot);
          }

          if (typeof event.data.green_teams === "number" && !isNaN(event.data.green_teams)) {
            for (let i = 0; i < event.data.green_teams; i++) {
              const dot = document.createElement("div");
              dot.classList.add("dot", "green");
              dot.style.width = scaledPx();
              dot.style.height = scaledPx();
              rightDots.appendChild(dot);
            }
          }
        }
        // Store last configured values for future Reset
        if (typeof minutes === "number" && typeof seconds === "number") {
          lastConfigured.seconds = minutes * 60 + seconds;
        }
        if (typeof teams === "number") {
          lastConfigured.red = teams;
        }
        if (typeof green_teams === "number") {
          lastConfigured.green = green_teams;
        }
        if (event.data.dot_size) {
          lastConfigured.dotSize = event.data.dot_size;
        }
        hasConfig = true;                // we now have a config
        resetStage = 0;
        optionsBtn.classList.remove("hidden");   // show Edit/Pencil button
        // ‚îÄ‚îÄ Keep Reset visible as long as countdown value > 0
        if (totalSeconds > 0) {
          resetBtn.classList.remove("hidden");
        } else {
          resetBtn.classList.add("hidden");
        }
        updateButtonsLayout();
        // --- Session indicator update ---
        const sessionIndicator = document.getElementById("session-indicator");
        if (sessionIndicator) {
          const session = event.data.session_id || "default";
          sessionIndicator.textContent = `Session ID: ${session}`;
          // Save selected session to sessionStorage
          sessionStorage.setItem("session", session);
          updateAddressBar(session);
          // Dynamically update QR image source
          const qrImg = document.querySelector(".qr-section img");
          if (qrImg) qrImg.src = `/qr-image?session=${encodeURIComponent(session)}`;
        }
        // Immediately apply this session's UI config without a reload
        if (typeof loadAndApplyConfig === 'function') {
          loadAndApplyConfig(true);
        }
        // ---
        console.log("‚úîÔ∏è Settings applied:", event.data);
      }
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Step 3: Load and apply /api/config on page load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadAndApplyConfig(preserveTimer = false) {
    // Preserve the timer state
    const preservedTime = totalSeconds;
    try {
      const currentSession = getCurrentSession();
      const resp = await fetch(`/api/config?session=${encodeURIComponent(currentSession)}`);
      if (!resp.ok) throw new Error("Cannot fetch /api/config");
      config = await resp.json();
      console.log("üîß Loaded session config:", config);

      // 1) If there's a background_image set (not null/empty), use it:
      if (config.ui && config.ui.background_image !== null && config.ui.background_image !== "") {
        lastKnownBackgroundImage = config.ui.background_image;
        document.body.style.backgroundImage = `url("/static/${config.ui.background_image}")`;
        document.body.style.backgroundSize = "cover";
        document.body.style.backgroundRepeat = "no-repeat";
        document.body.style.backgroundPosition = "center";
        document.body.style.backgroundColor = "";
      } else if (config.ui?.background_image === null && config.ui?.background_color) {
        lastKnownBackgroundImage = null;
        document.body.style.backgroundImage = "none";
        document.body.style.backgroundColor = config.ui.background_color;
      } else if (lastKnownBackgroundImage) {
        document.body.style.backgroundImage = `url("/static/${lastKnownBackgroundImage}")`;
        document.body.style.backgroundSize = "cover";
        document.body.style.backgroundRepeat = "no-repeat";
        document.body.style.backgroundPosition = "center";
        document.body.style.backgroundColor = "";
      }

      // 3) If there's a font_family, apply it:
      if (config.ui && config.ui.font_family) {
        document.body.style.fontFamily = `"${config.ui.font_family}", sans-serif`;
      }

      // 4) If there's a font_color, apply it:
      if (config.ui && config.ui.font_color) {
        timerDisplay.style.color = config.ui.font_color;
      }
      // ‚îÄ‚îÄ‚îÄ Set pill‚Äëbutton colours from config ‚îÄ‚îÄ‚îÄ
      const primary = (config.ui && config.ui.font_color)        || '#333';
      const secondary = (config.ui && config.ui.background_color) ? primary+'99' : '#666';
      document.documentElement.style.setProperty('--btn-primary', primary);
      document.documentElement.style.setProperty('--btn-secondary', secondary);

      // Restore the timer state after applying config if preserveTimer is true
      if (preserveTimer) {
        totalSeconds = preservedTime;
        updateTimerDisplay();
        // Reapply dot size to all visible dots
        const dotSizeMap = {
          S: 1.0,
          M: 2.00,
          L: 3.00,
          XL: 4.00
        };
        const scale = dotSizeMap[config.ui?.dot_size] || 1.0;
        document.querySelectorAll(".dot").forEach(dot => {
          dot.style.width = `${Math.round(16 * scale)}px`;
          dot.style.height = `${Math.round(16 * scale)}px`;
        });
      }
    } catch (e) {
      console.warn("Could not load/apply config:", e);
    }
  }

  // On DOMContentLoaded (i.e. when page first loads), run:
  window.addEventListener("DOMContentLoaded", loadAndApplyConfig);

  // ‚îÄ‚îÄ‚îÄ Initialize embedded QR with current session ‚îÄ‚îÄ‚îÄ
  window.addEventListener("DOMContentLoaded", () => {
    const session = getCurrentSession();
    const qrImg = document.querySelector(".qr-section img");
    if (qrImg) {
      // include session param if not default
      qrImg.src = session && session !== "default"
        ? `/qr-image?session=${encodeURIComponent(session)}`
        : "/qr-image";
    }
    updateButtonsLayout();   // ensure correct layout at startup
  });

  // You can also call loadAndApplyConfig() after each time you reload/reset the dots, etc.
  </script>
</body>
</html>